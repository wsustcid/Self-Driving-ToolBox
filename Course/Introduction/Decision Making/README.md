- [3. 行为决策](#3-行为决策)
  - [3.1 概述](#31-概述)
    - [3.1.1 自动驾驶汽车行为决策子系统](#311-自动驾驶汽车行为决策子系统)
    - [3.1.2 决策算法研究现状](#312-决策算法研究现状)
  - [2. 基于规则的行为决策](#2-基于规则的行为决策)
    - [2.1 场景划分](#21-场景划分)
    - [2.2 个体决策](#22-个体决策)
    - [2.3 综合决策](#23-综合决策)
  - [3. 基于马尔科夫决策过程的行为决策](#3-基于马尔科夫决策过程的行为决策)
    - [3.1 马尔可夫决策过程](#31-马尔可夫决策过程)
    - [3.2 部分可观马尔可夫决策过程](#32-部分可观马尔可夫决策过程)
  - [4. 安全性评估方法](#4-安全性评估方法)
    - [4.1 路权](#41-路权)
    - [4.1  RSS模型](#41--rss模型)
  - [5. Apollo中的决策技术](#5-apollo中的决策技术)


# 3. 行为决策
根据现代决策理论的发展历程，可以将决策理论分为 理性决策理论 和 行为决策理论。
  - 理性决策理论认为决策者会从完全理性的角度，根据其所能获得的所有准确的、完全的决策信息，得出一个最优的或者具有最大效用的决策方案。在20世纪80年代以前，这种理论处于主导地位。
  - 行为决策理论是一个多学科交叉的研究领域，其主要内容就是从决策者的决策行为作为出发点，研究决策者的认知过程，揭示决策者的判断和选择的原理解释，而非对决策对错的评价

从认知原理学的角度，研究决策者在做决策过程中的信息处理机制及其所受的内外环境影响。简单来说，行为决策理论探讨“人们是怎样进行决策的”以及“为什么会这么决策”的理论。

## 3.1 概述
行为决策层在整个自动驾驶汽车规控软件系统中扮演这个“大脑”的角色。这个层面汇集了上游所有模块处理得到的信息，
主要包括：
  - 汽车当前自身状态：位置、速度、朝向、当前所在车道、需要进入的下一车道等
  - 所有的路径寻由结果：包括为了到达目的地，需要进入的车道（Target Road）等。
  - 周围障碍物信息：一定范围内所有障碍物的信息：如周围汽车所在的车道、他们的位置、速度、朝向以及他们的接下来的行驶意图和预测轨迹；周围行人的位置、速度、轨迹等。
  - 历史决策信息：上一个决策周期自动驾驶汽车所做出的决策：跟车、停车、转向、换道等。
  - 周围交通标识信息和交通规则信息：如道路限速、是否可以红灯右拐等

行为决策层就是在知晓这些信息的基础上，决定自动驾驶汽车的行驶策略，使得自动驾驶汽车可以安全的到达目的地。

由于其信息处理的复杂性，行为决策模块需要解决的问题一般很难抽象成简单的数学模型，并且根据具体实现的不同，在宏观上定义的输出指令集也多种多样。
  - 在自动驾驶汽车的系统设计中，有时行为决策模块被单独设计独立的模块，有时也会和下游的运动规划模块融合到一起实现
  - 但总的原则是要保证行为决策模块的输出逻辑要和下游的运动规划模块的逻辑配合一致。
  - 在具体实现上，目前主要有**基于规则的**确定性行为决策系统和**基于MDP的**非确定性行为决策建模方法。


### 3.1.1 自动驾驶汽车行为决策子系统
决策算法面临的最大挑战就是如何达到自动驾驶所需要的高安全和高可靠性。无人驾驶汽车为了能在各种交通场景下正常行驶，其行为决策子系统需要具备以下特性：
  - 合理性：决策子系统应输出在某些评判标准下被认定合理的驾驶行为
  - 实时性：针对复杂的动态交通场景，行为决策系统能根据外部环境的变化，快速做出驾驶策略上的响应，避免危险情况的发生。
  
典型的无人驾驶汽车行为决策子系统如下所示：
<div align=center><img src=./figs/dm_system.png width=400></div>

具体来讲  
  - 行为决策系统首先会分析道路结构环境，明确自身的驾驶场景
  - 在此基础上，针对特定的驾驶场景，基于基本交通规则或驾驶经验组成的驾驶先验知识，在多个可选行为中基于驾驶任务需求等要素条件，选择此场景下的最优驾驶行为。
  - 由于不同的驾驶场景对应不同的驾驶场景对应不同的驾驶行为，为了避免系统的冗余，根据环境的运动变化规律分场景的进行决策，不仅能提高决策的实时性，更能保证决策的合理性。


### 3.1.2 决策算法研究现状
目前，主要有四种行为决策模型。

**有限状态机模型**  
状态机模型通过构建状态有限的有向连通图来描述不同驾驶状态以及状态之间的转移关系，然后车辆根据当前环境选择合适的驾驶行为，如停车、换道、超车、避让等，进而根据驾驶状态的迁移反应式的生成驾驶动作。
  - 有限状态机模型简单易行，是无人驾驶领域目前最广泛的行为决策模型，但该类模型忽略了环境的动态性和不确定性；
  - 并且，当驾驶场景比较多时，状态的划分和管理比较繁琐，多适用于简单场景下，很难胜任具有丰富结构化特征的城区道路环境下的行为决策任务

**决策树模型**  
决策树模型和状态机模型类似，也是通过当前驾驶状态的属性值反应式的选择不同的驾驶动作，但不同之处在于该类模型将驾驶状态和控制逻辑固化到了树形结构中，通过自顶向下的“轮询”机制进行驾驶策略搜索
  - 这类决策模型具备可视化的控制逻辑，并且控制节点可复用；
  - 同样，当状态空间、行为空间较大时，控制逻辑将比较复杂
  - 且同样无法考虑交通环境中的不确定性因素

**基于知识的推理决策模型**  
基于知识推理的决策模型通过构建由 “场景特征 -> 驾驶动作”的映射关系来模仿人类驾驶员的行为决策过程。具体可以通过将驾驶知识存储在知识库或神经网络中，知识库主要表现为 规则、案例或场景特征到驾驶动作的映射，最后通过“查询”机制从知识库或训练过的网络结构中推理出驾驶动作
  - 该类模型主要包括基于 (a). 基于规则的推理系统、(b). 基于案例的推理系统、(c). 基于神经网络的映射模型等
  - 总的来讲，这类模型对先验驾驶知识和训练数据的依赖性较大，需要对驾驶知识进行精心整理、管理和更新
  - 虽然基于神经网络的映射省去了数据标注和知识整合的过程，但仍然存在：所需数据量大、可解释性差、和回溯性差等问题

**基于价值的决策模型**  
根据最大效用理论，基于效用/价值的决策模型的基本思想是依据选择准则在多个备选方案中选择出最优的驾驶策略/动作
  - 为了评估每个驾驶动作的好坏，该类模型定义了效用(utility)或价值（value）函数，根据某些准则属性定量的评估驾驶策略符合驾驶任务目标的程度。
  - 对于无人驾驶任务，这些指标可以是安全性、舒适度、行车效率等
  - 几个典型的包括包括：
    - 利用多准则决策方法从候选动作集中选择最优的驾驶动作；
    - 基于POMDP的行为决策模型用以解决存在感知不确定性的情况；
    - 基于PCB（Prediction and-Cost-function Based）的行为决策模型，其侧重点在于如何构建恰当的代价函数来指导对环境的预测；
    - 为了解决在多智能体参与的复杂环境中的决策问题，许多基于博弈论的模型也被研究者用来推理车辆之间的交互行为；
    - 此外，因为在特征提取方面的优势，深度强化学习技术也开始被广泛应用，以完成最优驾驶动作的生成


## 2. 基于规则的行为决策
基于规则的行为决策其核心思想是利用分治的原则将自动驾驶汽车周边的场景进行划分，在每个场景中，独立运用对应的规则来计算自动驾驶汽车对每个场景中元素的决策行为，再将所有划分的场景的决策结果进行综合，得到一个最后综合的总体行为决策。

### 2.1 场景划分
场景是对自动驾驶汽车周边环境进行的一系列具有相对独立意义的划分。通过场景划分，可以将行为决策层汇集到的汽车周边不同类别的信息元素，聚类到不同的具有实际意义的场景实体中。如前后方汽车、两侧车道等都是最基本的场景。

场景的定义是分层次的：
  - 主车被认为是最基本的底层场景，其他所有场景的构建都需要先以自动驾驶汽车主车在哪里这一基本场景为基础
  - 第一层场景包括红绿灯、前后方汽车、左右两侧车道、汽车等
  - 路口场景是第二层的复合场景，其中的元素包括第一层的人行横道、红绿灯以及主车等场景

场景决策示例：
  - 基于上述场景定义，假设在路口场景：第0层自动驾驶主车的意图是右转
  - 第一层场景路口是红灯，可以右转，但没有道路优先权，需要避让其他汽车
  - 如果此时又感知到行人在人形横道的场景横穿马路
  - 那么综合以上场景中的元素决策，最终得到的综合决策是在针对行人在人行横道前停车。

### 2.2 个体决策
个体决策是指对所有重要的行为决策层面的输入个体，都产生一个决策。这里的个体，可以是感知输出的路上的车和行人，也可以是结合了地图元素的抽象个体，如红绿灯或人行横道对应的停止线等。

个人决策产生的决策指令，同时也带有参数数据。如针对前方车辆X超车这一决策，附带的参数数据包括超车距离和时间限制：
  - 距离代表本车车身需要超过X车头的最小距离
  - 时间代表这段超车距离至少需要X继续行驶的最小安全时间间隔

### 2.3 综合决策
综合决策代表自动驾驶汽车行为决策层面的整体的最高层级的决策，其所决策的指令状态空间定义需要和下游的运动规划模块保持一致，为了便于下游直接执行，综合决策的指令集同样也带有具体的指令参数数据：
  - 行驶：当前车道；目标车速；
  - 跟车：当前车道；跟车对象；目标车速；跟车距离；
  - 转弯：当前车道；目标车道；转弯属性；转弯速度；
  - 换道：当前车道；目标车道；加速并道；减速并道；
  - 停车：当前车道；停车对象；停车位置；
基于以上宏观决策指令及对应的参数数据，结合地图信息（如车道形状等），下游的运动规划模块便可以直接规划出安全无碰撞的行驶路线。

那么会不会出现不同场景对同一个物体通过各自独立的规则计算出的决策相互矛盾？
  - 首先在场景划分时，就已经尽可能的避免了同一物体出现在不同的场景中；
  - 其次，即使这种矛盾出现，在确定最终决策前，我们也会对所有的个体决策进行汇总和安全无碰撞的验证。

**行为决策示例**
  - 首先结合主车信息、地图数据及感知结果构建不同层次的场景；
  - 然后在全局路径规划的指引下，每个场景结合自身的规则（往往是交规或安全避让优先），计算出属于每个场景物体的个体决策；
  - 在所有的个体决策计算之后，模块会检查有无冲突的个体决策；
  - 在对冲突的个体决策进行冲突解决（往往是优先避让）后，推演、预测当前的所有个体决策能否汇总成一个安全形势无碰撞的综合决策。
  - 如果这样的安全无碰撞综合决策存在，便将其和个体决策一起输出给下层的运动规划模块，计算具体从当前位置到下一位置的时空轨迹。
<div align=center><img src=./figs/dm_demo.png width=400></div>

再具体一些，以无人车的变道决策规划为例(有时会把决策规划放到一起去做)：
  - 首先进行不同道路上的策略规划：我们有两种策略可供选择，继续本车道直线行驶的主车道策略和变道行驶的变道策略。因为后续有可能变道失败或认为变道不安全放弃变道策略。
  - 不同策略之间相互独立：不同策略之间用不同的参考系，且不同参考系内的交通规则也是完全独立的，这样后续也衍生出两个规划问题：本车道行驶的规划和变道的规划；(这两个车道所遵循的交通规则的约束条件是不一样的，比如两个车道的红绿灯可能不一样，两个车道的路权也可能不一样，因为我们所有信息如障碍物距离等都是基于参考系完成的，因此这两个车道我们用两个不同的参考独立建模)
  - 最后再对这两个策略做一个比较，选择出最优的选择。 

## 3. 基于马尔科夫决策过程的行为决策
### 3.1 马尔可夫决策过程
我们把自动驾驶行为决策建模成一个马尔可夫决策过程，用一个五元组$(S, A, T, R, \gamma)$ 表示：
  - $S$ 代表自动驾驶汽车所处的有限状态空间：状态空间的划分可以结合自动驾驶汽车当前位置及其在地图上的场景进行设计：例如在位置维度，可以考虑将自动驾驶汽车按照当前所处位置划分为等距离的格子；或参考地图场景，将汽车所处车道和周边道路情况归纳到有限的抽象状态中。
  - $A$ 代表自动驾驶汽车的行为决策空间：即自动驾驶汽车在任何状态下的所有行为空间的集合，如 当前车道跟车(Follow), 换道(Change Lane), 左右转（Turn Left/Right）, 路口的先后关系（Yield/Overtake）,遇到行人或红绿灯时的停车(Stop)等
  - $T$ 为状态转移函数：$T(s, s') = P(s' | s, a)$ 是一个条件概率，代表自动驾驶汽车在状态s和动作a下，到达下一个状态s'的概率。
  - $R$ 是激励函数：$R(s',s)$代表自动驾驶汽车在动作a下，从状态s转移动s'所获得的激励。该激励函数可以考虑安全性、舒适性、可通行性、到达目的地的能力，以及下游运动规划执行难度等因素进行综合设计。
  - $\gamma \in (0,1)$ 是激励的衰减因子，下一个时刻的激励便按照这个因子进行衰减: $\gamma ^t$. 表示当前的激励总是比未来的激励更重要。

自动驾驶行为决策层要解决的问题便是在上述MDP的定义下，寻找一个最优 “策略”：在任意给定的状态s，该策略会产生一个动作a。最优策略的选取目标是从当前时间点开始到未来的累计激励的最优值：$J = \sum_t^\infty \gamma^t R_{a_t} (s_t, s_{t+1})$。在上述定义下，达到最优收益的策略通常可以使用动态规划求解。

### 3.2 部分可观马尔可夫决策过程
在马尔科夫决策过程的基础上，部分客观马尔科夫决策过程考虑环境的部分可观察性（如其他车辆的驾驶意图等），用一个六元组进行定义：$S, A, \omega, T, O, R$:
  - 状态空间S: POMDP的状态空间需要能够涵盖局部规划窗口内动态实体的所有可能状态，因此将状态空间定义为无人驾驶汽车自身和周围其他汽车的运动状态，对于无人驾驶汽车自身，主要考虑其在局部栅格地图中的位置坐标、速度和航向；对于其他汽车，除了考虑位置、速度、航向以外，还需要考虑驾驶意图
  - 动作空间A: 一般分为横向驾驶动作 (加速、匀速、减速和停车) 和纵向驾驶动作 (左换道、右换道、车道保持、路口直行、路口左转、右转等)
  - 观察函数 $\omega$：$S,A,O -> [0,1]$，表示在给定的执行动作A和环境状态s下，智能体观察序列集合为O的概率分布
  - 状态转移模型T: 是POMDP模型的核心模块，重点描述驾驶场景状态随时间的演进过程，为驾驶动作生成提供前瞻信息。包括无人驾驶汽车自身的状态转移和其他汽车的状态转移（包括运动状态的转移和驾驶意图的转移）
  - 观察集合 $O$ ：表示观察序列的集合
  - 激励函数R: 对自主驾驶任务完成程度的定量评估，通常根据多个目标属性进行定义，如
    - 安全性：对碰撞设定负激励
    - 舒适度：对驾驶动作切换和紧急动作进行惩罚
    - 任务完成度：
    - 任务完成效率：对较高行驶速度进行奖励

总的来讲，在基于POMDP进行自动驾驶决策的过程中，决策模块可以与周围环境进行交互并从感知模块获取观察结果，然后通过更新当前状态的概率分布来更新其对真实状态的信念，使得决策模块计算出的最佳行为可能是为了帮助汽车更好的感知周边环境，对环境有更好的观察，从而能够在未来做出更好的决策。

## 4. 安全性评估方法
### 4.1 路权
路权是指道路使用者，依据法律规定，在一定时间内对一定的道路空间使用的权利。在智能驾驶中，路权可以用来描述满足汽车当前安全行驶所需的道路空间。
  - 在具体实践中，路权通常被定义为一个流动的扇形区，它与本车的尺寸、速度、周边的车流量、前方拥有的空间密切相关，是本车速度的非线性函数，可以用距离和角度来表示
  - 比如判断是否需要超车：当本车道车间距较小，且没有变大趋势，路权受限，超出容忍； 同时，如果相邻车道车间距较大，且没有变小趋势，路权允许； 则可从换道窗口确定换道路径，执行换道。
  - 路权可分为期望路权和实际路权，当两者不一致时，就需要进行调节来解决冲突。智能汽车在行驶中需要对路权进行检测和使用，多车交互是车群在任意时刻对路权的竞争、占有、放弃等协同过程。驾驶的不确定性同时也体现在汽车行驶中拥有的路权在不断的变化。
  
  
### 4.1  RSS模型
为了评估自动驾驶系统中决策模块的输出结果，Mobileye开发了一套责任敏感安全模 Responsibility Sensitive Safety (RSS) 的体系，通过将人类驾驶过程中对于安全程度的判断理念和概念具体化为数学公式，来判别什么样的决策才是安全的驾驶，并为具体的决策行为产生指导。

总的来讲，包含五大基本原则：
<div align=center><img src=./figs/rss.png width=600></div>


更多细节，参见相关参考文献
  - MobileEye Responsibility Sensitive Safety
  - Implementing the RSS Model on NHTSA Pre-Crash Scenarios 
  - Pre-Crash Scenario Typology for Crash Avoidance Research
  - On a Formal Model of Safe and Scalable Self-driving Cars


## 5. Apollo中的决策技术
详见 [此文档](doc/Apollo-Decision-Making.pdf)