
## 4.6. 规划模块问题实例
**规划模块系统架构**  
<div align=center><img src=./figs/planning_overview.png width=400></div>

  - 首先从无人车的位置开始，基于路网文件，建立起多条参考线，进行参考线的预选：如主车策略的参考线、换道策略的参考线等
  - 然后对于不同的参考线建立不同的参考系，在不同参考系内部进行路径规划：
  - 通过动态规划寻找软约束条件
  - 通过二次规划生成平稳的轨迹

**道路内规划**
  - 首先将所有道路信息整合到道路中心线构建的平滑参考系上：一般来讲，从高精地图处获得道路中心线不够平滑。
    - 这种平滑指的是车辆执行这条轨迹时控制指令的平滑性：一般要保证曲率二阶可导，即转方向盘的速率是比较连续的。
    - 可对原始参考线进行采样打点，然后利用这些点重新拟合出一条平滑的轨迹
  - 然后寻找一个满足交通规则的道路内的最优解：这条轨迹要满足安全性的约束条件
  - 最后要注意规划时的性能上的优化

**道路内规划的硬约束和软约束**
  - 对于交通规则这种必须遵守的硬约束，通过编写规则的形式将其写入代码
  - 对于一些人为的决策这种软约束，通过将规则建模成优化策略进行实现。如对于前方车辆，是选择跟车还是绕行。
  - 最后基于上述决策，采用基于样条的二次规划生成一条平稳的轨迹


### 6.1 道路内规划中的优化问题
总的来讲，道路内的规划问题是一个三维的规划问题，三个维度分别为：平面道路内曲线的横(L)、纵向坐标(S)以及运动所需的时间坐标(T), 因为这是一个非凸的问题，很难实时的求解出一条实时的轨迹。具体做法是将此问题降维成一个速度规划和路径规划问题进行迭代求解：
  - E Step 路径SL投影 -> M Step 路径SL优化
  - E Step 速度ST投影 -> M Step 速度ST优化

优化问题的三个关键点
  - 目标函数：各项指标的线性叠加；平滑性指标如曲率的变化率，安全性指标如安全距离
  - 约束条件：满足交规，避免碰撞
  - 优化求解：求解出无人车平滑行驶的轨迹

解决非凸函数优化问题的思路：
  - 首先通过撒点获取粗略解：对应规划模块的动态规划算法 (DP)
  - 然后通过QP二次优化获取精确解：对应规划模块的二次样条 (QP)

### 6.2 路径规划
首先基于SL坐标系，从主车位置出发，向前方撒若干排点，通过设置Cost目标函数，利用动态规划，生成一条折线形式的路径的粗略解，这个粗略的解虽然可能不是很平滑，但可以为后续的二次规划提过一个良好的参考。(主要参考就是从障碍物右侧通过cost更低)
<div align=center><img src=./figs/planning_dp.png width=400></div>

进一步可以对纵向坐标S取若干个可以控制的位置，然后再获取这些位置的在L坐标轴上的上下界，作为二次规划的约束条件(图中橘黄色的区域)，这样就构建成了一个凸问题，进而可以进一步精确求解
<div align=center><img src=./figs/planning_qp.png width=400></div>

### 6.3 速度规划
上一步我们生成了无人车的一条可行路径，但目前还不知道他应该以何种速度进行在此路径上行驶。首先我们将周围的障碍物投影到我们将要行驶的路径上：如下图所示，如果障碍物出现在上方位置，代表位于主车前方，我们优先在其后面跟车行驶，反之如果在下方，速度较慢，我们优先在其上方，进行超车行驶。

首先第一步还是把S-T图离散化成网格之后，利用动态规划的方式寻找图中红线这种粗略解：
<div align=center><img src=./figs/planning_dp_vel.png width=400></div>

同样有了粗略解之后，我们可以得到一个可求解的区域，在这个可求解区域中，同样是一个凸问题。
<div align=center><img src=./figs/planning_qp_vel.png width=400></div>

总的来讲，就是一个路径和速度不断迭代，每次得到的路径，帮助下一步规划速度，而规划出的速度，又会为下一阶段的路径规划提供参考。在路径和速度规划的内部，是通过动态规划和二次规划的结合实现的。


### 6.4 逆行障碍物路径规划实例
下图解决逆行问题的例子很好的体现了进行EM迭代规划的优势：
<div align=center><img src=./figs/planning_ex1.png width=400></div>
  - 如果我们仅进行一次路径规划和一次速度规划，分别会的到图1和图2，当车辆还没运动到避障位置时，可能就已经撞上了。(没有得到自己的速度规划前，很难预估出和障碍物的相遇位置)
  - 当我们再次进行迭代规划时，上一次的速度规划结果会给我们一些参考：如果我们按照图2规划出速度进行行驶时，我们就可以大致判断出障碍物可能运动到的位置，进而就可以帮助我们的路径规划得到一个真正能够避开障碍物的路径，然后再次进行速度规划，就能得到一个理想的减速避障结果。

### 6.5 算法提速
**投影与离散化**
之前已经提到，当我们进行道路内的规划时，首先会对障碍物进行一个投影，但当障碍物非常多时，如果对每一个障碍物都进行投影，投影的时间复杂度会指数上升（比如一个拥堵的路段）。解决方案之一就是我们可以对障碍物的投影信息进行离散化，投影完之后在利用这些信息时通过打表的方式把障碍物的信息进行一个整合，整合之后的信息就不会随着障碍物的增多，信息的复杂度增加，最终通过查表降低时间复杂度。(类似于Occupation Grid?)

**二次规划热启动**
解决二次规划问题一般是通过牛顿迭代的方式实现的，因为前一个周期生成的轨迹很有可能和当前周期要生成的轨迹差不多，那么我们就可以用历史轨迹做一个启发来进行当前周期轨迹的求解，称之为二次规划问题的热启动

### 6.6 规划问题难点汇总与处理思路
**决策的可执行性**
  - 决策规划信息不一致，纯基于规则的得到的决策指令规划模块无法执行，因为你再决策时并没有实际生成一条轨迹去尝试是否真的实际可执行。有些情况过于保守
  - 解决：把决策分为硬约束条件和软约束条件，实现从规则 到 规则+DP 的方式实现决策

**换道等新策略**
  - 换道策略问题，可能换道换一半发现换不过去了。没有主动换道，成功率不高
  - 解决：将策略进行分离，分别进行道路内与道路间的决策规划

**规划的平稳性**
  - 体感，时速低于30km/h, 画龙，U-Turn 不稳定
  - 解决：平滑道路中心线的生成

**时效性**
  - 瘸腿的，平均200-300 ms，端到端600 ms
  - 算法优化与架构优化




### 1.1 问题定义
**规划的本质**
  - 规划的本质是一个搜索问题：即寻找目标函数f(x)的最优解 (注意x可能是一个函数，比如一条轨迹)。
  - 无人驾驶中的运动规划亦是如此，给定一个无人车的初始状态，寻找无人车具体如何去运动的一个最优解，其最优性的衡量由目标函数定义。
  - 在机器学习中，被定义为一个寻找Mapping的过程，根据当前State(输入)，map到一个Action(输出)，来Optimize Loss Function.

**规划的领域**
  - Robotic Fields: How to generate trajectory to accomplish goals. 
    - RRT, A*, D* Lite, Lattice Planning, and etc.
  - Control Theory: Dynamic system to reach a target state.
    - MPC, LQR, etc
  - AI: generate state action mappings
    - Reinforcement Learning, End-to-End Imitation Learning and etc.

**规划问题的建模**
从简单到复杂，逐步解决:
  - 首先可以不考虑速度，不考虑环境变化，且对环境信息是Fully Obesrved，只是解决一个 Path Finding Problem
    - Non-informative Search: BFS, DFS
    - Heuristic Search：A* (包含关于目标的信息)
  - Partially Observed: 找不到全局最优，只能贪心的去找
    - Incremental Search： D*: 
  - 处理动态障碍物，考虑动力学模型
  - 考虑交通规则
  - 考虑算法时效性

注意：我们最后需要得到的不是简单的一条path，而是一个trajectory，本质上是一个三维空间的规划问题。