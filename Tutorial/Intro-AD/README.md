- [自动驾驶汽车决策规划技术](#自动驾驶汽车决策规划技术)
  - [1. 背景介绍](#1-背景介绍)
  - [2. 路由寻径](#2-路由寻径)
  - [3. 行为决策](#3-行为决策)
  - [4. 运动规划](#4-运动规划)
  - [5. 仿真实践](#5-仿真实践)
  - [6. 技能要求](#6-技能要求)
  - [参考资料](#参考资料)


# 自动驾驶汽车决策规划技术

## 1. 背景介绍
自动驾驶汽车是指能够感知环境、自动规划路线并控制汽车到达目的地的一种智能汽车。

**自动驾驶系统分级**  
美国国家公路交通管理局(NHTSA) 和 国际自动化工程师协会 (SAE) 分别对汽车的自动驾驶能力进行了分级，前者分为L0-L4五个等级，后者分为L0-L5六个等级（后者对前者的L4进行了详细的划分）：
  - L0: 人工驾驶：没有任何自动驾驶或辅助驾驶功能，驾驶员拥有对车辆的绝对控制权。
  - L1: 辅助驾驶：驾驶员仍然负责驾驶过程中的绝对安全，但一些辅助功能如自适应巡航(ACC)、紧急制动辅助(EBA)、车道保持支持(LKS)系统可以自主完成。
  - L2: 部分自动驾驶：驾驶员与汽车协同控制。驾驶员已经不是主要的操控管理者，但仍是驾驶安全的掌控者，需要随时准备接管控制。如结合ACC与LKS的自主跟车功能。
  - L3: 条件自动驾驶：在有限条件下汽车将具有自主驾驶能力，自动驾驶系统已经可以独立负责整个汽车的控制，不再需要人对车和驾驶环境的监管。但特殊紧急情况下仍需人来接管。但核心是汽车的驾驶安全主控权此时已经交给自动驾驶系统了。
  - L4: 完全自动驾驶：整个过程已经无需驾驶员的参与，可以空车运行。

**自动驾驶系统硬件组成**
<div align=center><img src=./Doc/figs/av_hardware.png width=600></div>
<div align=center><img src=./Doc/figs/av_sensor.png width=600></div>
当算法成熟以后，可以将一部分计算直接采用Soc的方式集成到芯片上，进行边缘计算，减少后续系统的计算消耗。

**自动驾驶系统技术架构**
<div align=center><img src=./Doc/figs/av_system.png width=500></div>

**自动驾驶系统关键技术**
  1. 高精度地图与高精度定位技术：
  2. 环境感知技术：
  3. 智能决策技术：包括危险事态建模、危险预警与控制优先级划分、群体决策与协同、局部轨迹规划、驾驶员多样性分析等
  4. 控制执行技术：
  5. V2X通信技术：
  6. 云平台与大数据技术：
  7. 信息安全技术：
  8. 标准法规与测试评价：

**自动驾驶系统决策规控模块**
广义上的自动驾驶汽车的规划控制主要包括 路由寻径(Routing)、行为决策(Behavioral Decision)、运动规划(Motion Planning) 以及控制(Control)这几个部分。
  - 这样划分可以使整个复杂的问题得到分解，每个模块可以各司其职专注解决本层次的问题，使得整个复杂软件系统的开发实现模块化和并行化。
  - 劣势在于各个模块之间计算结果的一致性问题：行为决策在作出决定时，要尽可能保证前后一致且最大可能的让下游的运动规划模块可以执行；同时，运动规划模块规划出的轨迹速度也应当严格的控制在下游反馈控制可以执行的范围内。

**决策规划模块的四个基本要求**
  - 安全性：最基本要求便是要确保车辆安全的从起点到达终点
  - 计算速率：小于100ms
  - 平滑性：轨迹平滑
  - 稳定性：能适用各种复杂路况

**如何系统性的解决决策规划问题**
  1. 首先要明确目的和问题，什么是无人车能做的，什么是不能做的:
     - 要确保遵守交通规则
     - 明确它是一个路网内的规划问题，不是自由空间中的规划问题，因此和地图的关系是强依赖的
  2. 其次遵循从简单到复杂的设计思路:
     - 先解决没有任何障碍物、交通灯时的规划问题，看能否实现汽车平稳直行、转弯
     - 考虑障碍物停车、跟车及红绿灯下的规划问题
     - 考虑障碍物减速绕行、十字路口等场景
     - 被动换道
     - 主动换道 
  3. 最后具体问题的解决优先考虑将问题分解，分而治之：
     - 场景划分：静态障碍物、动态障碍物
     - 规划分解：位置规划与速度规划分离

**决策规划问题的输入与输出**
总的来讲，决策规划模块的输入为上游模块的环境信息，包括定位模块、感知模块、导航模块、预测模块等。输出为一条无人车可以执行的轨迹，最后交由下游的控制模块执行。具体来讲，输入包括
  - 障碍物信息与预测轨迹：位置、速度、长宽高等及预测轨迹；
  - 本车状态：主要包括个来源，一部分是通过车辆底盘获得的方向盘角度、速度等；另一部分是定位模块获得的，位置、朝向等
  - 交通灯信息：
  - 高精地图信息：路径中心线、边界、到边界距离、类型、限速等及路径间的拓扑关系；
  - 导航信息：路径级别的导航


## 2. [路由寻径](Routing/README.md)
我们通常提到的全局路径规划便是路由寻径部分: 其根据起点和终点信息，采用 *路径搜索* 算法找出一条 *最优* 的路径（时间最短、距离最短等）。
  - 注意，这里的路由寻径虽然在一定程度上类似于传统的汽车导航，但其细节上紧密依赖于 *专门为自动驾驶汽车导航绘制的高精地图*，和传统的导航有本质的不同；
  - 普通地图是一种描述道路级几何的精度在5-10m的2D地图
  - 而高精地图是一种描述车道级几何的精度在10-20cm的3D地图
  - 路由寻径可以在行驶前离线一次完成，也可以在形式过程中不断的重新规划


## 3. [行为决策](Decision_Making/README.md)
在确定全局路径之后，自动驾驶汽车需要根据具体的道路状况、交通规则、其他车辆和行人的状态来做出具体的行驶策略。目前，行为决策层主要涉及三个方面的问题：
  - 首先，实际驾驶场景千变万化，如何找出合适的决策策略能够覆盖所有驾驶场景？
  - 其次，真实的驾驶场景是一个多智能体决策环境，包括主车在内的每一个交通参与者做出的行为都会对其他参与者带来影响，影响其下一步的状态，从而更加增加了决策的复杂度。（交通参与者行为预测 -> 多智能体协同决策）
  - 最后，自动驾驶车辆无法做到对周围环境的完全感知，因此我们的决策实际是一种不确定性决策

综上，解决复杂环境下、基于感知不确定性的多智能体系统决策问题，是实现L4,L5级别自动驾驶的核心问题！


## 4. [运动规划](Motion_Planning/README.md)
运动规划可以理解为局部路径规划，其目的是基于环境地图，在汽车局部坐标系下寻找一条满足汽车运动学和动力学约束以及舒适性指标的局部无碰撞路径，该局部路径必须具备对全局期望路径的跟踪能力和避障能力。
  - 首先，基于汽车局部坐标系，根据汽车定位信息将全局期望路径转化到汽车坐标系下进行表示，以此作为局部期望路径，为局部路径规划提供参考信息
    - 局部期望路径是无人驾驶汽车未来一段时间内的期望行驶路线，因此，路径上的每一点都要求可以表示汽车的状态信息
    - 每个路径点的坐标和切向方向代表汽车的位置和航向，路径点的曲率半径代表汽车的转弯半径
  - 然后，通过路径生成完成对期望路径的跟踪：由于汽车在行驶中，位置、航行和转弯半径是连续变化的，因此，生成的路径也要满足位置、航向和曲率的连续变化
  - 最后，通过路径选择完成障碍分析，得到无碰撞路径


## 5. 仿真实践
自动驾驶汽车的研发流程主要分为四个步骤：
  - 基于仿真模拟的     软件在环
  - 基于硬件平台的     硬件在环
  - 基于车辆执行的     车辆在环  (封闭场地)
  - 基于实际道路的     司机在环  (研究人-车-路之间的相互作用)


## 6. 技能要求
对于规控模块的设计开发，一般需要掌握以下知识：
  - 基础工具：Linux，Ros，Rviz，Docker，Cmake，Git，gdb等工具
  - 编程语言：C++, python, bash
  - 计算几何: 向量，标量，矩阵，坐标转换，碰撞检测，曲线，直线相交，点到线距离等
  - 机器人学：车辆动力学、运动学模型
  - 数值优化：梯度下降，QP，序列二次规划等
  - 决策算法：MDP，POMDP，状态机，决策树，贝叶斯理论等
  - 规划算法：DP, A*，hybird A*，RRT，Dijkstra，多项式，贝塞尔，b样条，RS曲线，dubins曲线，圆弧曲线，螺旋曲线等
  - 控制算法：MPC，LQR，模糊控制，PID等
  - 博弈论：Level-K, 纳什均衡
  - 深度学习：模仿学习
  - 强化学习：逆强化学习
  - 驾驶能力: 熟悉交通规则
  - 仿真工具: Apollo，carla，Lgsvl, sumo


## 参考资料
  - [第一本无人驾驶技术书](https://item.jd.com/12572815.html#crumb-wrap)，刘少山等，电子工业出版社，2017.
  - [自动驾驶汽车决策与控制](https://item.jd.com/12803814.html)，杨世春等，清华大学出版社，2020.
  - [Autonomous Driving Technical, Legal and Social Aspects](https://www.springer.com/gp/book/9783662488454), Markus Maurer, Springer, 2016.















