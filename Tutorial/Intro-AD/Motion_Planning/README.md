- [4. 运动规划](#4-运动规划)
  - [4.1 问题概述](#41-问题概述)
    - [4.1.1 问题描述](#411-问题描述)
    - [4.1.2 研究现状](#412-研究现状)
  - [4.2 可行驶区域生成](#42-可行驶区域生成)
    - [4.2.1 Voronoi 图](#421-voronoi-图)
    - [4.2.2 占用栅格](#422-占用栅格)
    - [4.2.3 状态网格(State Lattice)](#423-状态网格state-lattice)
    - [4.2.4 驾驶通道](#424-驾驶通道)
  - [4.3 局部轨迹规划-直接构造法](#43-局部轨迹规划-直接构造法)
    - [4.3.1 Dubins和Reeds-shepp曲线](#431-dubins和reeds-shepp曲线)
    - [4.3.2 多项式螺旋曲线](#432-多项式螺旋曲线)
    - [4.3.3 样条曲线](#433-样条曲线)
  - [4.4 局部轨迹规划-路径-速度分解法](#44-局部轨迹规划-路径-速度分解法)
    - [4.4.1 局部路径搜索](#441-局部路径搜索)
    - [4.4.2 汽车速度规划](#442-汽车速度规划)
    - [4.4.3 轨迹评估](#443-轨迹评估)
  - [4.5. 机器学习方法](#45-机器学习方法)
    - [4.5.1 模仿学习](#451-模仿学习)
    - [4.5.2 逆强化学习](#452-逆强化学习)
  - [4.6 参考资料](#46-参考资料)


# 4. 运动规划
## 4.1 问题概述
### 4.1.1 问题描述
运动规划问题的本质是在一定约束条件下，完成某个区域或范围内时间、空间状态下的路径、速度优化，或称之为汽车在一定时间空间内的行驶轨迹优化。最终得到的优化轨迹应该包含：
  - 汽车到达每个位置的时间
  - 该位置上的行驶速度、加速度、曲率、曲率的高阶导数
  - 以及其他与时间相关的运动变量信息

通常建模为二维平面上的时空曲线优化问题，为了简化问题难度，通常分解为一下三个步骤完成：
  - 建立包含障碍物区域和自由区域的环境地图，生成可行驶区域
  - 在环境地图中选择合适的路径搜索算法，快速实时的搜索可行驶路径
  - 进行汽车轨迹和速度规划

运动规划与全局路径规划的区别：
  - 全局路径规划的结果是汽车的位姿序列，并不考虑汽车位姿参数虽时间变化的因素
  - 运动规划赋予路径时间信息，对汽车的速度和加速度进行规划，以满足光滑性和速度可控性等要求

注意，运动规划模块不仅需要其上游行为决策模块的输出，同样也需要接入感知和地图定位模块的输出，这样冗余设计的好处主要有两点：
  - 一是如果仅仅依靠决策模块传递感知结果，如果在决策模块计算完决策结果后，出现新的感知物体将会被规划模块忽略，带来安全隐患。
  - 二是如果决策模块除了问题，这是规划模块虽然没有了对交规和周围环境行为层面的决策，但仍然拥有感知和地图的完整信息，也能实现最基本的避障，提升系统安全性。

### 4.1.2 研究现状
广义上的路径规划算法可以分为一下五类：
  - 基于图搜索的方法：A*, D*, APF
  - 基于采样的方法：PRM, RRT
  - 基于插值拟合的方法: Clothoids, Spline Polynomials
  - 基于数值优化及智能算法: DP, QP, NN, GN, PSO, ASO
  - 多融合算法：PRM-Node based, APF-RRT
前面两种主要用于全局路径规划，后面两种主要用于局部路径规划。不同的方法之间各有优劣，使用时根据具体需求进行选择。

<div align=center><img src=./figs/planning_timeline.png width=600></div>

<div align=center><img src=./figs/planning_team.png width=600></div>


## 4.2 可行驶区域生成
汽车运动规划需要环境以一种可寻径的方式表达，因此必须将物理空间转换为具体的状态空间。汽车行驶时通过读取传感器信息和从电子地图中获取信息，将环境的连续体转换为道路网络的数字表示。环境的离散化必须在效率、密度和表达能力之间做合理的取舍

### 4.2.1 Voronoi 图
Voronoi通过最大化汽车与周围障碍物之间的距离来生成路径。
  - 在Vornnoi上进行搜索的算法是完整的
  - 其典型应用场景是静态环境下的规划，如停车场
  - 其本身并不适合公路路径规划，因为汽车导航的Voronoi图边缘可能不连续

<div align=center><img src=./figs/voronoi.png  width=600> </div>

**Voronoi图定义**  
沃罗诺伊图（也称作Dirichlet tessellation 狄利克雷镶嵌或泰森多边形）是一种空间分割算法。他通过一系列的种子节点将空间分割为许多子区域，每个子区域被称为cell，每个cell中所有点到当前此cell种子节点的距离均小于到其他种子节点的距离。

假设种子节点的序列为 $\{ x_1, x_2, ..., x_n | x_i \in R^d, i=1,...n \}$， 其中$R^d$ 表示种子节点在d维空间的坐标点，这n个种子节点可以将d维空间切分为n个cell，每个cell的定义为：
$$ V_i = \{x \in R^d| \forall j \neq i, d(x, x_i) \leq d(x, x_j) \} $$

换句话说，每个cell中包含的点都是距离当前cell(种子点)最近的点，反之，那么每个cell的边界就是cell内距离种子点最远点的集合。

**Voronoi建立步骤**    
  1. 基于所有离散点构建Delaunay三角网，并对离散点和形成的三角网进行编号，记录每个三角形是由哪三个离散点构成的
  2. 找出并记录与每个离散点相邻的所有三角形的编号（即对每个离散点，找出所有包含该顶点的三角形）
  3. 对于与每个离散点相邻的三角形，按顺时针或逆时针方向排序：(a). 设离散点为o,找出以o为顶点的一个三角形，设为A; (b). 取三角形A除o以外的另一顶点a,则另一个顶点b也可以找出；(c) 找出下一个以ob为边的三角形B,然后可以确定另一个剩余顶点c，即可继续找出以oc为边的三角形C;(d)以此类推，直到回到oa边。
  4. 计算并记录每个三角形的外接圆
  5. 根据每个离散点的相邻三角形，连接这些三角形外接圆的圆心，即可得到泰森多边形（对于三角网边缘的泰森多边形，可做垂直平分线与图廓相交，与图廓一起构成泰森多边形）。

**基于Voronoi图进行路径规划**    
我们可以利用沃罗诺伊图中cell的边界是距离种子点最远点的集合这一特性，将障碍物的边界当做种子点，最后生成的cell边界就是远离所有障碍物的可行驶路径。具体实施步骤如下：
  1. 原始地图如图1所示，移动机器人工作区域内包含建筑物或其他类型的障碍，通常用凸的或凹的多边形表示
  2. 首先，用大量的点来逼近多边形障碍物的边界，这些点将原始多边形的每一侧的边分成一些小的线段，逼近结果如图2所示；
  3. 然后，基于这些逼近点计算其沃罗诺伊图，其结果如图3所示；
  4. 对于沃罗诺伊图中的每条边，若边的端点之一或全部位于障碍物内部，则将此边剔除，剩下的边就构成了能够避开所有障碍物的可行驶路径集合，最终得到图4；
  5. 最后，将沃罗诺伊边转化为图结构，并在图中确定规划任务的起始节点，然后采用图搜索算法如Dijkstra确定一条从起始节点到终止节点的最优路径,得到图5。
  6. 基于Voronoi Planner 得到的路径和基于采样得到的路径二者的区别如图6所示，明显可以看出，前者得到的路径的特点并不是路径最短，而是尽量远离障碍物。
  7. 但同基于采样得到路径一样，Voronoi Planner得到曲线也是不平滑的折线，所以也需要对路径进行平滑操作，比如可以通过定义目标方程，如 $Cost = c_1 ||x_i - y_i|| + c_2 || y_i - y_{i+1}||$, 第一项衡量偏离原始轨迹的程度，第二项衡量轨迹点之间的距离。然后可以通过梯度下降的方法来最小化目标函数实现轨迹平滑。

<div align=center><img src=./figs/voronoi_planner.png  width=600> </div>

**参考文献与相关代码**
  - [Robot Path Planning Using Generalized Voronoi Diagrams](https://www.cs.columbia.edu/~pblaer/projects/path_planner/)
  - Local and Global Motion Planning for Unmanned Surface Vehicle，Roman Fedorenko, Boris Gurenko
  - [Voronoi Diagram](https://www.boost.org/doc/libs/1_60_0/libs/polygon/doc/voronoi_diagram.htm)
  - [scipy.spatial.Voronoi](https://docs.scipy.org/doc/scipy-0.18.1/reference/generated/scipy.spatial.Voronoi.html)
  - [PythonRobotics/voronoi_road_map.py](https://github.com/AtsushiSakai/PythonRobotics/blob/master/PathPlanning/VoronoiRoadMap/voronoi_road_map.py)
  - [Voronoi Diagram](https://www.boost.org/doc/libs/1_60_0/libs/polygon/doc/voronoi_diagram.htm)

### 4.2.2 占用栅格
占用栅格与成本地图的含义相似，都是将状态空间划分为网格，这些网格的每个单元都代表当前单元被障碍物占据的概率，或者代表通行风险的代价值。
  - 风险或可通行性主要通过考虑障碍物、车道和道路边界来进行计算
  - 在计算能力较低的情况下，基于网格的方法能够快速找到解决方案
  - 并且，占用网格可以包含障碍物的位置和速度信息，从而可以推测他们的预期运动
  - 但难以保证符合汽车动力学要求，且障碍物的表示不够准确

### 4.2.3 状态网格(State Lattice)
状态网格就是在普通栅格地图的基础上，增加了机器人运动学模型的约束，确保相邻两点间生成的路径是机器人可实际执行的，并且能够具有状态连续性（速度连续等）。状态网格地图同样可以看做一个有向图，因此我们可以利用常用的图搜索算法进行路径规划，选择最优路径。
<div align=center><img src=./figs/state_lattice.jpg  width=600> </div>

**状态网格生成**  
对于普通的栅格点，可以通过给定栅格距离直接进行生成，而状态网格需要结合机器人的运动空间去生成，主要有基于控制空间采样的方法和基于状态空间采样的方法两种
  - **控制空间采样（前向采样）**：通过机器人的运动学模型，我们给定输入控制量u和积分时间t,则可预测后面时刻机器人的状态，因此我们可以从当前位置出发，通过对控制空间采样，预测机器人未来所有可行的轨迹，从而得到一系列轨迹的集合，最终得到满足机器人运动学约束的状态网格。(如图1所示)
  - **状态空间采样（后向采样）**：状态空间采样与控制空间采样相反，通过先指定相邻点，然后结合机器人模型，逆向计算从当前点到相邻点的轨迹。虽然逆向采样的计算较为复杂，但因为其考虑了目标点的反向规划，可以同时考虑障碍物的环境信息和机器人的运动学模型，因此这种方法更为常用

**参考文献与相关代码**
  - [Efficient constrained path planning via search in state lattices](http://robotics.estec.esa.int/i-SAIRAS/isairas2005/session_04b/4_pivtoraiko_4b.pdf)
  - Differentially Constrained Mobile Robot Motion Planning in State Lattices
  - Spatiotemporal state lattices for fast trajectory planning in dynamic on-road driving scenarios
  - https://github.com/Alanaab/MotionPlanning
  - https://github.com/amslabtech/state_lattice_planner

### 4.2.4 驾驶通道
驾驶通道代表汽车能够在其中行驶的一个连续的无碰撞空间，其受到道路、车道边界以及其他障碍物的限制
  - 驾驶通道的生成可以基于详细数字地图上给出的车道边界信息形成驾驶通道的外部边界，并结合障碍物的位置共同决定
  - 或者基于SLAM技术建立的地图
  - 确定驾驶通道之后，利用通道的中心线，即可形成汽车运动的大致规划轨迹
  - 这种连续规划的缺点在于需要高强度的计算能力才能实现道路网络整个坐标范围内的规划，因此对道路或车道的表示方法可能会制约汽车的运动


## 4.3 局部轨迹规划-直接构造法
局部轨迹规划的核心便是局部轨迹的生成，其目的是生成由一系列轨迹点所定义的轨迹，并且每个轨迹点都会分配一个时间戳和速度，然后让一条曲线与这些轨迹点拟合，生成轨迹的几何表征，因为时间戳的存在，我们最后得到的是一个三维轨迹（移动的障碍物可能会暂时阻挡部分路段，但因为路段的每个轨迹点都有时间戳，可以通过将时间戳与预测模块的输出结合起来，确保在汽车通过时轨迹上的每个点都未被占用）。直接构造法和路径-速度分解法是常见的局部轨迹生成方法：
  - 直接构造法得到的运动轨迹，需要满足速度与加速度、曲率与曲率导数的有界性，更为复杂
  - 路径速度分解法将构造“曲率连续有界的路径”与“在此路径上生成连续有界的速度且保证加速度、曲率导数的有界性”的过程分开，使得运动规划的难度降低

直接构造法通过构造汽车后轴中心坐标关于时间的函数，构造出一条充分拟合初始和终止位置、以及速度与加速度的路径，适用于非结构化的环境。
  - 通常该函数可以使用5次多项式，有利于保证汽车行驶的平稳性，因为这种路径加速度变化率最小。
  - 但如要保证规划出来的整条路径在速度、加速度、曲率、和曲率变化率方面的有界性，还需要不断调整轨迹时间区间

### 4.3.1 Dubins和Reeds-shepp曲线
1957年，Dubins证明，任何路径都可以由最大曲率的圆弧段和直线段组成。Dubins曲线和Reeds-Shepp曲线是在满足曲率约束和规定的始端和末端切线方向的前提下，连接两个二维平面的最短路径。其中，Dubins曲线要求汽车只能前向行驶，Reeds-shepp则前后向都可以。
<div align=center><img src=./figs/dubins.gif  width=300><img src=./figs/reeds-shepp.gif  width=270> </div>

(1). Dubins曲线的类型可以用与汽车驾驶行为类似的“右转（R）, 左转（L）和 直行（S）”来描述，其最佳路径总是以下六种类型之一： RSR, RSL, LSR, LSL, RLR, LRL
  <div align=center><img src=./figs/dubins_demo.png  width=600></div>

(2). 当环境中存在障碍物时，Dubins曲线不一定存在，但只要起止位姿之间存在无碰撞路径，Reeds-Shepp曲线则一定存在。(即使是Z字型曲线，也可以找到一条Reeds-Shepp曲线)
  <div align=center><img src=./figs/reeds-shepp_side.gif  width=300><img src=./figs/reeds-shepp_obstacle.gif  width=300> </div>

(3). 当圆弧段和直线段存在曲率不连续时，汽车依据曲线行驶时需要在不连续处停车调整方向轮才可以继续行驶：回旋线可用于解决此问题。回旋线曲率和曲线长度成正比关系，通过使用回旋线改造Dubins和Reeds-Shepp曲线，作为直线到圆弧间的过渡曲线，可以保证曲率的连续性。

**参考文献**
  - [1] On Curves of Minimal Length with a Constraint on Average Curvature, and with Prescribed Initial and Terminal Positions and Tangents，Lester E. Dubins，American Journal of Mathematics.
  - [2] Optimal Paths for a Car That Goes both Forwards and Backwards，J. A. Reeds and L. A. Shepp，Pacific Journal of Mathematics.

### 4.3.2 多项式螺旋曲线
多项式螺旋曲线是一类用弧长的多项式函数来表示曲率的曲线簇。常用的为三阶或五阶的多项式螺旋线，其曲率$\kappa$ 和轨迹弧长$s$的关系如下：
$$\kappa(s) = a_0 + a_1s + a_2s^2 + a_3s^3 $$
$$\kappa(s) = a_0 + a_1s + a_2s^2 + a_3s^3 + a_4s^4 + a_5s^5 $$
<div align=center><img src=./figs/poly_curve.png  width=600></div>

以三阶多项式为例，考虑汽车的初始状态$q_{init} = (x_0, y_0, \theta_0, \kappa_0)$ 和 目标姿态$q_{final} = (x_f, y_f, \theta_f, \kappa_f)$，二者具有连续曲率的三阶螺旋线，则使用三阶多项式螺旋线连接的轨迹，其参数可以通过梯度下降法进行快速搜索：
  1. 首先在初始状态$s=0$时，曲率函数的一阶导数和二阶导数均应满足初始条件的限制，即
     $$ \kappa_0 = \kappa(0) = a_0 $$
     $$ \dot{\kappa_0} = d\kappa(0)/ds = a_1 $$
     $$ \ddot{\kappa_0} = d^2\kappa(0)/ds^2 = a_2 $$
  2. 通过上述约束条件，未知参数仅还剩两个$a_3$和$s$，得到一类曲线簇
  3. 最后我们可以根据不同需要，来设置代价函数，利用梯度下降法求解出代价最小且满足边界条件限制的曲线

### 4.3.3 样条曲线
不管是dubins曲线还是多项式螺旋曲线，都是采用*曲线拟合*的方式直接生成曲线来逼近给定点。除了曲线拟合，我们还可以采用*曲线插值*的方式，通过连接所有给顶点，构造特征多边形，然后通过样条插值构造光滑曲线，增加拟合曲线和目标轨迹的匹配程度。
  - 样条曲线的形状受多边形的顶点和位置的影响，其中用于确定样条曲线的多边形被称为特征多边形或控制多边形
  - 多边形的顶点被称为样条曲线的控制点，样条曲线在数据拟合中需要穿过的给定点被称为型值点
  - 样条曲线可通过数值计算，利用参数调整，最终形成逼近控制多边形的点和边的光滑曲线
  - 典型的样条曲线包括 贝塞尔曲线(Bezier)曲线 和 B样条(B-Spline)曲线

**[贝塞尔曲线](https://zh.wikipedia.org/wiki/%E8%B2%9D%E8%8C%B2%E6%9B%B2%E7%B7%9A)**   
贝塞尔曲线完全由控制点决定其形状，n个控制点对应n-1阶的贝塞尔曲线，其核心特征是可以通过递归的方式来绘制：
  - 一阶贝塞尔曲线由两个控制点$P_0$和$P_1$控制，则其利用位置参数t在两点之间进行线性插值，可以得到一条直线线段，根据不同的t值可以得到该线段上任意位置的坐标，其曲线方程为：
    $$B_1(t) = (1-t)P_0 + tP_1 , t \in [0, 1] $$
  - 二阶贝塞尔曲线由三个控制点A, B, C 基于一阶贝塞尔曲线生成：
    - 首先在线段AB上任选一点D，基于同样的比例AD:AB在BC上找到点E
    - 连接DE，则DE又是一条由两个控制点控制的线段，则其上的点可以通过一阶贝塞尔曲线进行线性插值生成
    - DE的左端点为 $P'_0 = (1-t)P_0 + tP_1$
    - DE的右端点为 $P'_1 = (1-t)P_1 + tP_2$
    - 则二阶贝塞尔曲线为 $B_2(t) = (1-t)P'_0 + tP'_1 $,带入后得到
    $$ B_2(t) = (1-t)^2P_0 + 2t(t-1)P_1 + t^2P_2, t \in [0, 1] $$
  - 三阶贝塞尔曲线可由同样的步骤生成，分别在AB, BC,CD上找到点E,F,G，然后在EF,FG上找到H,I，最后在HI上找到最终的控制点J
    $$ B_3(t) = (1-t)^3P_0 + 3t(t-1)^2P_1 + 3t^2(1-t)P_2 + t^3P_3$$
  - 则通用的由n+1个控制点控制的n阶贝塞尔曲线方程为
    $$ B_n(t) = \sum_{i=0}^n B_{i, n}(t) P_i,  t \in [0, 1]$$
    $$ B_{i,n}(t) = C_n^i t^i (1-t)^{n-i} = \frac{n!}{i!(n-i)!}t^i (1-t)^{n-i}, i=[0,1, ..n] $$

<div align=center><img src=./figs/bezier.png  width=650></div>

贝塞尔曲线具有如下性质：
  - (1). 各项系数之和为1且对称：以为系数是二项式的展开，可直接得到 
  - (2). 递归性：递归性是指其n阶系数可由n-1阶系数递归得到$ B_{i,n}(t) = (1-t)B_{i, n-1}(t) + tB_{i-1, n-1}(t) $
  - (3). 端点性质：第一个控制点和最后一个控制点恰好是曲线的起始点和终止点；这一点可通过其系数直观得到，当t=0或t=1时，只有起始点或末尾点系数为1，其余各项均为0；
  - (4). 一阶导数性质：贝塞尔曲线起始点和终止点处的一阶导数分别是第一条边和最后一条边的斜率
  - (5). 二阶导数性质：贝塞尔曲线起点和终点处的二阶导数分别只与前三个控制点和后三个控制点有关；

由上述性质可知，若要满足位置连续约束条件，则需要两个控制点（第一个和最后一个）；若要满足方向连续条件，则需要四个控制点（前两个和倒数两个）；若要满足曲率连续约束条件，则需要6个控制点；因此，要实现贝塞尔曲线对两线段的光滑过渡，则需要至少6个控制点，阶次至少为5次。

具体的运动轨迹可以使用[de Casteljau算法](https://zh.wikipedia.org/wiki/%E5%BE%B7%E5%8D%A1%E6%96%AF%E7%89%B9%E9%87%8C%E5%A5%A5%E7%AE%97%E6%B3%95) 计算出贝塞尔曲线
<div align=center><img src=./figs/Bezier_1.gif  width=200><img src=./figs/Bezier_2.gif  width=200><img src=./figs/Bezier_3.gif  width=200></div>

<div align=center><img src=./figs/Bezier_4.gif  width=300><img src=./figs/Bezier_5.gif  width=156></div>


**B样条曲线**  
之前提到的贝塞尔曲线主要有两个特性：(1). 阶次由控制点的个数决定 (2). 移动一个控制点，整个曲线都会产生变换； 这两个特性在设计复杂曲线时就会造成曲线的阶次非常高，且牵一发而动全身，很难进行局部的调整。

为了克服上述缺点，B样条曲线应运而生：B样条曲线通过把一条曲线变成多段贝塞尔曲线的拼接，移动控制点时仅仅改变曲线的部分形状，而不影响整体，并且可以指定阶次。B样条有三大要素：
  - 节点：设T是m+1个非递减数的集合，其中$t_1 <= t_2 <= t_3 .. <= t_m$，则$t_i$称为节点；集合T称为节点向量；半开区间$[t_i, t_{i+1})$是第i个节点区间；
    - 如果节点等距，节点向量或节点序列称为均匀的，否则他是非均匀的；
    - 节点可以认为是分隔点，将整个区间分割成m个小的节点区间，通常我们令$t_0=0, t_m = 1$; 节点向量可以是$[0, 0.3, 0.5, 0.7, 0.9, 1.0]$;
  - 控制点：与贝塞尔曲线相同，控制点就是空间上决策曲线形状的点
  - 阶次: 定义B样条的基函数是一个k阶分段多项式， $N_{i,k}(t)$是第i个k阶B-样条基函数，其递归定义为
    $$ N_{i,k}(t) = \frac{t-t_i}{t_{i-k-1}-t_i} N_{i,k-1} +  \frac{t_{i+k}-t}{t_{i+k}-t_{i+1}} N_{i+1,k-1}, k>=1$$
    $$ N_{i,0}(t) = 1, t_i<=t<=t_{i+1}, N_{i,0}(t)=0, otherwise$$
    - 由递归公式可以看出，想要确定第i个k阶B样条基函数，需要用$t_i, t_{i+1}, ..., t_{i+k}$共k+1个节点，则区间$[t_i, t_{i+k}$称为$N_{i,k}$的支撑区间

则由控制点$P_0, P_1, ... , P_n$构成的k阶B样条曲线的数学表达式为
$$ B_n(t) = \sum_{i=0}^n N_{i, k}(t) P_i $$


## 4.4 局部轨迹规划-路径-速度分解法
<div align=center><img src=./figs/pos_vel_framework.png  width=600></div>
在有移动障碍物的场景下，路径-速度分解法通过将整个运动规划过程拆分为 避开静态障碍物 和 避开动态障碍物 两步进行：
  - 首先构造一条能够避开静态障碍物的路径
  - 然后在此路径之上进行进行速度规划使之能够避开移动障碍物
<div align=center><img src=./figs/pos_vel_demo.png  width=600></div>

### 4.4.1 局部路径搜索
进行汽车局部轨迹的规划主要分为三个步骤完成：
  - 首先与全局路径规划问题类似，同样可以通过启发式搜索，如A*, Dijkstra，或随机采样的方式进行局部轨迹的粗略搜索或生成，但更常用的是采用动态规划寻找局部最优路径
  - 与全局路径规划不同，规划出的局部轨迹需要足够平滑且满足汽车运动学和动力学的要求，使得在进行后续路径跟踪时，实际车辆可以真正实现对路径的完全跟踪。因此，在搜索出粗略路径后，还需要进一步通过样条曲线或QP算法进行路径平滑
  - 最后可结合汽车运动学和动力学模型进行轨迹的进一步优化

**使用DP算法进行路径初步搜索**
<div align=center><img src=./figs/dp_path_search.png  width=600></div>  

  - 首先，基于道路中心线构造S-L坐标系，S代表沿中心线的方向，L代表与中心线正交的方向
  - 然后，基于给定的中心路径(Reference Line)和车道边界条件，在纵向上每隔一定距离（称为不同级上的S值）对道路截面进行均匀采样（与中心点的横向偏移值称为L值），从而得到采样点数组(Waypoint,航迹点)
  - 进而可以基于一定的规则，给出各航迹点迁移的代价值。注意：航迹点迁移不一定非要逐级进行，可以跳跃甚至直接到终点（典型的DP问题）
  - 最后，基于S-L轨迹：$l(s) = (l_1, l_2, ..., l_n)$，可以构建包含重叠子问题的优化目标函数：
      $$ minCost(l_n|l_{n-1}) = minCost(l_{n-1}) + Cost(l_{n-1}, l_n) $$
  - 路径规划过程的目标函数可以考虑以下因素进行构建：与道路中心线的偏差；路径曲率与路径连续性、与障碍物应保持的合理距离、路径曲率与汽车运动特性的符合度等

**使用QP算法进行局部路径平滑**    
通过路径搜索得到的路径虽然能够避开障碍，但因为是通过节点连接起来的折线，因此不利于汽车进行跟踪，因此还需要进一步对路径进行平滑处理
  - 可以通过之前介绍的B样条曲线对路径进行平滑，[参考](https://www.cnblogs.com/21207-iHome/p/7843517.html)；
  - 也可以使用QP算法进行平滑，可以更好的考虑限制条件

QP问题的标准形式为：
  $$ min \frac{1}{2}\textbf{x}^T \textbf{H} \textbf{x} + \textbf{f}^T\textbf{x} $$
  $$ LB <= \textbf{x} <= UB $$
  $$ \textbf{A}_{eq}\textbf{x} = \textbf{b}_{eq} $$
  $$ \textbf{A}\textbf{x} <= \textbf{b} $$

将路径平滑问题建模为QP问题的步骤如下：  

(1). 首先在S-L坐标系中定义路径：
  - 参数s的取值范围为汽车当前位置到默认规划路径的长度
  - 将路径划分为n段，每段路径用一个多项式来表示
  - 每个样条段i都有带参考线的累加距离$d_i$
  - 每段路径用默认的五阶多项式表示：
    $$ l = f_i(s) = a_{i0} + a_{i1}s + a_{i2}s^2 + a_{i3}s^3 + a_{i4}s^4 + a_{i5}s^5, (0<=s<=di) $$

(2). 定义样条段优化函数并转化为QP目标函数：
  - n个样条段的优化目标函数为
    $$ Cost = \sum_{i=1}^{n}( w_1 \int_0^{d_i} f'_i(s)^2ds + w_2 \int_0^{d_i} f''_i(s)^2ds + w_3 \int_0^{d_i} f'''_i(s)^2ds ) $$
  - 以一阶导数项为例，其具体形式为：
      $$ f_i(s) = [1, s, s^2, s^3, s^4, s^5][a_{i0}, a_{i1},a_{i2},a_{i3},a_{i4},a_{i5}]^T$$
      $$ f'_i(s) = [0, 1, 2s, 3s^2, 4s^3, 5s^4][a_{i0}, a_{i1},a_{i2},a_{i3},a_{i4},a_{i5}]^T$$
      $$ f'_i(s)^2 = [a_{i0}, a_{i1},a_{i2},a_{i3},a_{i4},a_{i5}] [0, 1, 2s, 3s^2, 4s^3, 5s^4]^T[0, 1, 2s, 3s^2, 4s^3, 5s^4] [a_{i0}, a_{i1},a_{i2},a_{i3},a_{i4},a_{i5}]^T$$
  - 进一步对其求积分：
      $$ \int_0^{d_i} f'_i(s)^2ds = [a_{i0}, a_{i1},a_{i2},a_{i3},a_{i4},a_{i5}] \int_0^{d_i}([0, 1, 2s, 3s^2, 4s^3, 5s^4]^T[0, 1, 2s, 3s^2, 4s^3, 5s^4])ds [a_{i0}, a_{i1},a_{i2},a_{i3},a_{i4},a_{i5}]^T $$
  - 积分后可以得到一个6阶的矩阵，即为QP目标方程的标准形式

(3). 利用初始点约束和终止点约束构建等式约束：
  - 假设初始点为$s_0, l_0$，终止点为$s_e, l_e$,其对应的一阶，二阶导数分别为$l'_0, l''_0, l'_e, l''_e$；则起始点和终止点处的约束条件为：
      $$ f_i(s_0) = l_0 $$
      $$ f'_i(s_0) = l'_0 $$
      $$ f''_i(s_0) = l''_0 $$
      $$ f_i(s_e) = l_e $$
      $$ f'_i(s_e) = l'_e $$
      $$ f''_i(s_e) = l''_e $$
  - 将左边等式展开并合并，可得到一个 6x6 * 6x1 = 6x1的等式约束条件

(4). 将平滑节点约束转化为等式约束：
  - 假设两个段$seg_k$ 和 $seg_{k+1}$相互连接，且$seg_k$按节点的累加值s为$s_k$,则可以构建等式约束
      $$ f_k(s_k) = f_{k+1}(s_0) $$
      $$ f'_k(s_k) = f'_{k+1}(s_0) $$
      $$ f''_k(s_k) = f''_{k+1}(s_0) $$
      $$ f'''_k(s_k) = f'''_{k+1}(s_0) $$

(5). 利用采样点边界约束构建不等式约束：
  - 在路径上均匀的取m个点，基于道路的宽度和周围障碍物可以找到点$s_j, l_j$的上边界 $l_{lb,j}$和下边界 $l_{ub,j}$，其中$j=0,..m$
  - 将这m个点分别带入路径表达式f(s)，则可得到2m个不等式，可分别组成两个大的m维的不等式矩阵

**基于汽车运动学和动力学进行轨迹优化**
  - 待补充

### 4.4.2 汽车速度规划
速度规划是指：当局部路径规划给定了一条或若干条选出的路径曲线之后，在此局部路径的基础上加入与速度有关的信息（主要是为了实现对动态障碍物的规避）。在给路径点赋予速度和加速度信息时，需要考虑两个基本的前提条件：
  - 需要符合行为决策的输出结果；
  - 需要满足反馈控制的操作限制；

速度规划有以下常见方法：
  - 对路径指定线加速度来生成速度：指定线加速度是某一常数或是由比例-微分控制器来生成
  - 样条差值：将问题建模为 在给定时间内通过一段给定路径的速度生成问题。通过将时间域划分为若干区间，使用速度关于时间的三次样条函数来插值，但这一方法容易产生加速度变化率较大的问题
  - 函数拟合：直接用速度关于路径长度的二次多项式来生成速度
  - 目标时刻点法：首先根据对障碍物未来运动状态的预测，在规划路径与时间这两个维度构成的二维图中标记障碍物在未来一段时间内所占据的区域；以目标汽车当前车速匀速通过规划路径所需的时间为基准，根据一定原则创建一组目标时刻点；在此二维图中以目标时刻点为目标点搜索产生一组速度规划方案。

**利用ST图进行速度规划**  
通过引入S-T图，可以将速度规划归纳为S-T图上的路径搜索问题进行求解。S-T图是关于给定局部路径纵向位移(S)和对应时间T的二维关系图。任何S-T图都基于一条已经给定的轨迹曲线，根据自动驾驶汽车对动态障碍物的轨迹预测，每个动态障碍物都会在这条给定的轨迹上产生投影，从而产生对S-T图部分区域的覆盖，速度规划要做的事就是基于以上信息，重新规划出一条避开障碍物覆盖区域的路径，然后生成此路径需要的速度。

<div align=center><img src=./figs/vel_plan_1.png  width=600></div>  

(1). 障碍物轨迹预测
  - 如图1所示，当环境中出现移动障碍物的时候，移动障碍物会在未来某些时刻$(t_1, t_2, t_3)$占据已经规划好的路径；如果汽车仍然按照当前车速匀速行驶，则会在未来某一时刻与其发生碰撞。
  - 若已知移动障碍物当前所处位置$(x_{0obj},y_{0obj})$,速度 $(vx_{obj},vy_{obj})$ 以及加速度$(ax_{obj},ay_{obj})$,则可以预测经过时间t后移动障碍物所处位置$(x_{tobj},y_{tobj})$
    $$ x_{tobj} = x_{0obj} + vx_{obj}t + \frac{1}{2}ax_{obj}t^2 $$
    $$ y_{tobj} = y_{0obj} + vy_{obj}t + \frac{1}{2}ay_{obj}t^2 $$
 - 进一步可以写成矩阵形式，得到t时刻移动障碍物所处位置$\textbf{Y}$
   $$\textbf{Y} = \textbf{A}\textbf{X} $$
 - 根据移动障碍物所处位置$\textbf{Y}$可以计算其t时刻的覆盖区域$\textbf{Q}$
 - 如图2所示，基于$\textbf{Q}$可以计算其与规划路径$\textbf{S}$的交集$\Delta S = \textbf{Q} \cap \textbf{S}$
 - 对一系列时间t进行上述操作，则可以得到一系列与t一一对应的$\Delta S$

(2). S-T 图生成  
 - 如图3所示，依据上一步骤中得到的与t一一对应的$\Delta S$，可以在S-T图得到一块被障碍物占据的区域
 - 其中，$S_goal$为规划路径的长度
 - 虚线代表目标汽车以当前速度匀速沿规划路径行驶，用时记为$t_a$
 - 实现表示从当前时刻开始以最大加速度行驶，用时记为$t_{min}$

(3). S-T图栅格化
  - 为了在S-T中进行路径搜索，需要对S-T图进行栅格化；
  - 如图4所示，从当前时刻开始，根据采样周期，针对未来某一时刻$t_k$计算移动障碍物所处的位置$\textbf{Y}_k$,其中k为1-n的自然数，n的值依据移动障碍物离开规划路径的时刻确定。
  - {t_k}与{t_{k+1} 为采样周期
  - 基于步骤1中的同样的采用，可得到离散化的$\textbf{Y}_k$, $\textbf{Q}_k$
    $$\Delta S_k = \textbf{Q}_k \cap S_{xy}$$

<div align=center><img src=./figs/vel_plan_2.png  width=600></div>  

(4). 创建目标时刻点 
  - 既然要在S-T上进行搜索，就要确定搜索区间，根据步骤2中得到的$t_a$和$t_{min}$,很明显搜索时间的下界为
    $$Tt_{min} = min(t_a, t_{min}) $$
  - 因为在小于此时间的速度是已经固定了的，必然只能按照最大加速度运动，已没有任何规划的可能；无法让此时间进一步缩短，我们仅能规划从此下限开始的可能存在的运动
  - 从$Tt_{min}$开始向后等间隔产生一组时刻点，用$Ttr$表示，具体r的个数由移动障碍在S-T图中占据的区域确定
  - $Ttr$ 被称为目标时刻，其集合被记作$Tt$，称为目标时刻集；
  - 对应的路径点称为目标时刻点集合，记为$T_S$，我们接下来就要对从起点到目标路径点的路径进行搜索；

(5). 路径搜索
  - 首先，为了避免任何潜在的碰撞，所有动态障碍物物体经过的网格的Cost都需要调大
  - 然后，结合上游行为决策模块输出的信息，在路径搜索时可以灵活设置障碍物周边的代价(Cost),达到调整速度方案的目的
  - 当上游决定针对物体a进行抢先决策时，在S-T图上物体a运动路径的上方网格的Cost就可以调成偏小
  - 此外，还需要考虑一条给定速度方案在加速度等方面的Cost：比如S-T上过于陡峭的曲线代表加速度过大甚至不连续，这样很有可能反馈控制模块无法实际执行
  - 所以每条曲线所对应的速度方案均有一个整体的Cost
  - 实际上，根据上游决策输出和下游控制限制来调整Cost是速度规划中关键！
  - 基于设置好的Cost，我们就可以利用图搜索算法来搜索出一条最优的路径；
  - 最后，在得到最小Cost的路径之后，我们就可以简单算出局部路径上任何位置对应的速度(即S-T图上任一点的斜率)和加速度(斜率的导数)，最终完成速度规划的计算。

(6). 速度平滑
  - 因为在进行搜索时，我们对S-T图进行了离散化，因此得到的路径也是曲折离散的
  - 和局部轨迹规划相同，我们同样可以采用多项式拟合或QP算法对速度进行平滑操作。

### 4.4.3 轨迹评估  
评估一条轨迹的优劣通常基于代价函数，选择代价最低的轨迹。通常需要考虑汽车偏离中心线的距离、是否可能发生碰撞、速度限制、舒适度等因素。在实际操作中，汽车可以在不同环境中使用不同的成本函数
  - 在高速公路中：行车环境比较简单但车速较快，此时对自动驾驶汽车控制精度的要求很高，因此要重点关注位置的精度和路径搜索的速度
  - 在城市半结构化道路中：环境特征明显但交通环境比较复杂，周边障碍物较多，此时轨迹规划就要重点关注汽车对周边环境的建模和对避障路径的搜索能力，特别是对动态障碍物方向和速度的预测
  - 在越野环境的非结构化道路中：因为汽车所形式的环境没有明显的道路边界且道路起伏较大，此时对自动驾驶识别周边环境特别是对地形、地势的识别有较高要求，路径规划的侧重点主要在于可通行区域的识别


## 4.5. 机器学习方法
利用数据驱动解决运动规划问题目前来讲挑战大于优势。
### 4.5.1 模仿学习
  - 缺乏对环境的整体认知，仅适用于简单场景
  - 需要大量的数据进行训练，对数据的数量、质量、覆盖面都有较高要求
  - 可迁移性差，一旦应用于新的场景，汽车驾驶行为将难以预测；
  - 由于汽车与周围障碍物之间存在复杂的交互和约束关系，场景和状态通常难以重现，因此在训练采集的数据很难在测试中完全重现；

### 4.5.2 逆强化学习
  - 首先，自动驾驶系统需要保证公共道路交通的安全，在一点无论是在训练和测试时都非常重要。很多基于学习的方法需要足够的线上训练和线下测试反馈，这一过程很有可能危及道路安全
  - 其次，自动驾驶数据的 在线很困难，不同场景中的专家驾驶数据很容易收集，但要在仿真中再现则难度非常大，因为这一部分数据包含主车与周围环境的复杂交互
  - 最后，自动驾驶运动规划器不仅需要英东动态变化的复杂交通环境，还需要每时每刻遵守交通规则，则强化学习系统将这些约束整合起来并不简单；


## 4.6 参考资料
  - 规划算法基础: LaValle, Steven M. Planning Algorithms. Cambridge University Press, 2006.
  - 数值优化算法: Boyd, Stephen. Convex Optimization. Cambridge University Press, 2004.
  - 光滑样条算法: De Boor. A practical guide to splines. New York: Springer-Verlag 1978.

